---
apiVersion: v1
kind: ConfigMap
metadata:
  name: plex-cert-converter
  namespace: plex
data:
  convert-cert.sh: |
    #!/bin/sh
    set -e

    CERT_PATH="/certs/tls.crt"
    KEY_PATH="/certs/tls.key"
    P12_PATH="/shared-certs/plex.p12"
    P12_PASSWORD="${P12_PASSWORD:-changeme}"

    # Install required packages
    apk add --no-cache inotify-tools openssl

    convert_cert() {
      echo "Converting certificate to P12 format with modern encryption..."
      openssl pkcs12 -export \
        -out "$P12_PATH" \
        -inkey "$KEY_PATH" \
        -in "$CERT_PATH" \
        -keypbe AES-256-CBC \
        -certpbe AES-256-CBC \
        -macalg SHA256 \
        -passout pass:"$P12_PASSWORD"
      chmod 644 "$P12_PATH"
      echo "Certificate converted successfully at $(date)"
    }

    # Initial conversion
    if [ -f "$CERT_PATH" ] && [ -f "$KEY_PATH" ]; then
      convert_cert
    else
      echo "Waiting for certificates..."
    fi

    # Watch for certificate changes (renewals)
    while true; do
      inotifywait -qq -e modify,create,moved_to "$CERT_PATH" "$KEY_PATH" 2>/dev/null && convert_cert
      sleep 5
    done

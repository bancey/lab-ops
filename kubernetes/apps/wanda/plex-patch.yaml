---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: plex
  namespace: plex
spec:
  values:
    ingress:
      enabled: true
      url: https://plex.bancey.xyz
      ingressClassName: traefik
      tls:
        - hosts:
            - plex.bancey.xyz
            - plex.wanda.bancey.xyz
          secretName: plex-tls
    service:
      type: LoadBalancer
      annotations:
        lbipam.cilium.io/ips: 10.151.24.161
    pms:
      configExistingClaim: plex-config-pvc-nfs-static
    extraVolumes:
      - name: data
        persistentVolumeClaim:
          claimName: plex-data-pvc-nfs-static
      - name: private-data
        persistentVolumeClaim:
          claimName: plex-data-private-pvc-nfs-static
      - name: plex-tls-cert
        secret:
          secretName: plex-tls
      - name: shared-certs
        emptyDir: {}
      - name: cert-converter-script
        configMap:
          name: plex-cert-converter
          defaultMode: 0755
    extraVolumeMounts:
      - name: data
        mountPath: /data
      - name: private-data
        mountPath: /private-data
      - name: shared-certs
        mountPath: /etc/plex/certs
        readOnly: true
    # Add cert-converter init container to ensure P12 exists before Plex starts
    initContainers:
      - name: cert-converter-init
        image: alpine:3.19
        command: ["/bin/sh", "/scripts/convert-cert.sh"]
        env:
          - name: P12_PASSWORD
            valueFrom:
              secretKeyRef:
                name: plex-keystore-secret
                key: password
          - name: WATCH_MODE
            value: "false"
        volumeMounts:
          - name: plex-tls-cert
            mountPath: /certs
            readOnly: true
          - name: shared-certs
            mountPath: /shared-certs
          - name: cert-converter-script
            mountPath: /scripts
        resources:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            cpu: 100m
            memory: 64Mi
    # Add cert-converter sidecar to watch for certificate renewals
    extraContainers:
      - name: cert-converter
        image: alpine:3.19
        command: ["/bin/sh", "/scripts/convert-cert.sh"]
        env:
          - name: P12_PASSWORD
            valueFrom:
              secretKeyRef:
                name: plex-keystore-secret
                key: password
          - name: WATCH_MODE
            value: "true"
        volumeMounts:
          - name: plex-tls-cert
            mountPath: /certs
            readOnly: true
          - name: shared-certs
            mountPath: /shared-certs
          - name: cert-converter-script
            mountPath: /scripts
        resources:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            cpu: 100m
            memory: 64Mi

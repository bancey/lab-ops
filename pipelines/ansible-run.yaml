parameters:
  - name: hostsFilePath
    type: string
  - name: requirementsFile
    type: string
    default: ""
  - name: playbook
    type: string
  - name: keyVaultName
    type: string
  - name: privateKeySecretName
    type: string
  - name: serviceConnection
    type: string
  - name: extraVars
    type: string
    default: ""

steps:
  - task: AzureCLI@2
    displayName: Run Ansible Playbook
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      scriptType: "bash"
      addSpnToEnvironment: true
      scriptLocation: "inlineScript"
      inlineScript: |
        az keyvault secret download --name ${{ parameters.privateKeySecretName }} --vault-name ${{ parameters.keyVaultName }} --file $(Build.StagingDirectory)/id_rsa
        chmod 600 $(Build.StagingDirectory)/id_rsa
        eval `ssh-agent -s`
        ssh-add $(Build.StagingDirectory)/id_rsa
        REQUIREMENTS_FILE="${{ parameters.requirementsFile }}"
        echo "Requirements file: $REQUIREMENTS_FILE"

        if [ ! -z "$REQUIREMENTS_FILE" ]; then
          ansible-galaxy install -r $REQUIREMENTS_FILE
        fi

        EXTRA_VARS="${{ parameters.extraVars }}"
        echo "Extra Variables: $EXTRA_VARS"

        if [ ! -z "$EXTRA_VARS" ]; then
          ansible-playbook --inventory $(System.DefaultWorkingDirectory)/${{ parameters.hostsFilePath }} ${{ parameters.playbook }} --extra-vars "$EXTRA_VARS"
        else
          ansible-playbook --inventory $(System.DefaultWorkingDirectory)/${{ parameters.hostsFilePath }} ${{ parameters.playbook }}
        fi
      workingDirectory: $(System.DefaultWorkingDirectory)/ansible

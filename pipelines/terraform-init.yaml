parameters:
  - name: storageAccount
    type: string
  - name: workingDirectory
    type: string
  - name: azureRmKey
    type: string

steps:
  - script: |
      curl -L https://raw.githubusercontent.com/warrensbox/terraform-switcher/release/install.sh | bash -b  ~/_work/_tool/tfswitch
      set -x
      # Make sure ~/.local/bin is set for both root and non-root based agents (self-hosted etc)
      # Prepend PATH for other ADO tasks
      echo '##vso[task.prependpath]$(HOME)/_work/_tool/tfswitch'
      # Prepend PATH for current ADO task
      export PATH=$HOME/_work/_tool/tfswitch:$PATH
      tfswitch -b
    displayName: Install tfswitch
    workingDirectory: ${{ parameters.workingDirectory }}
  - task: TerraformCLI@0
    displayName: Terraform initialize
    inputs:
      command: init
      workingDirectory: ${{ parameters.workingDirectory }}
      backendType: azurerm
      ensurebackend: true
      backendServiceArm: 'MSDN Sub'
      backendAzureRmResourceGroupName: tfstate-rg
      backendAzureRmResourceGroupLocation: uksouth
      backendAzureRmStorageAccountName: ${{ parameters.storageAccount }}
      backendAzureRmStorageAccountSku: Standard_LRS
      backendAzureRmContainerName: tfstate
      backendAzureRmKey: ${{ parameters.azureRmKey }}.tfstate
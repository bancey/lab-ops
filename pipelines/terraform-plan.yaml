parameters:
  - name: serviceConnection
    type: string
  - name: workingDirectory
    type: string
  - name: variableFilePath
    type: string
  - name: env
    type: object
    default: {}
  - name: extraCommandArgs
    type: string
    default: ""

steps:
  - task: TerraformCLI@0
    displayName: Terraform validate
    inputs:
      command: validate
      workingDirectory: ${{ parameters.workingDirectory }}
  - task: TerraformCLI@0
    displayName: Terraform plan
    inputs:
      command: plan
      workingDirectory: ${{ parameters.workingDirectory }}
      environmentServiceName: ${{ parameters.serviceConnection }}
      publishPlanResults: $(System.StageDisplayName)
      ${{ if ne(parameters.extraCommandArgs, "") }}:
        commandOptions: ${{ parameters.extraCommandArgs }} -var-file ${{ parameters.variableFilePath }} -compact-warnings
      ${{ else }}:
        commandOptions: -var-file ${{ parameters.variableFilePath }} -compact-warnings
    env: ${{ parameters.env }}